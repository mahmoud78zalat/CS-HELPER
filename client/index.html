<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <title>Customer Service Helper</title>
    <style>
      /* Simplified, crash-safe Chatbase widget styles */
      *[id*="chatbase"], 
      *[class*="chatbase"],
      iframe[src*="chatbase.co"], 
      iframe[src*="embed.min.js"],
      #rG3h170PKdOsKKTC078sk {
        z-index: 2147483647 !important;
        position: fixed !important;
      }
      
      /* Safe modal overlay fix - minimal approach */
      .fixed.inset-0:not([id*="chatbase"]):not([class*="chatbase"]) {
        pointer-events: none !important;
      }
      
      .fixed.inset-0 > *:not([id*="chatbase"]):not([class*="chatbase"]) {
        pointer-events: auto !important;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    
    <!-- Chatbase Integration with Crash Protection -->
    <script>
      // Crash-safe Chatbase loader with comprehensive error handling
      (function() {
        let chatbaseLoaded = false;
        let loadAttempts = 0;
        const MAX_LOAD_ATTEMPTS = 3;
        
        // Error boundary for all Chatbase operations
        const safeChatbaseOperation = (operation, description) => {
          try {
            return operation();
          } catch (error) {
            console.error(`[Chatbase] ${description} failed:`, error);
            return null;
          }
        };
        
        // Safe DOM query with error handling
        const safeQuerySelectorAll = (selector) => {
          try {
            return document.querySelectorAll(selector);
          } catch (error) {
            console.error(`[Chatbase] Query selector failed for: ${selector}`, error);
            return [];
          }
        };
        
        // Crash-safe user detection
        const getCurrentUserSafely = () => {
          return safeChatbaseOperation(() => {
            return window.getCurrentUser && window.getCurrentUser();
          }, 'User detection');
        };
        
        // Safe script loading
        const loadChatbaseScript = () => {
          return safeChatbaseOperation(() => {
            if (loadAttempts >= MAX_LOAD_ATTEMPTS) {
              console.warn('[Chatbase] Max load attempts reached, aborting');
              return false;
            }
            
            loadAttempts++;
            
            const existingScript = document.getElementById('rG3h170PKdOsKKTC078sk');
            if (existingScript) {
              console.log('[Chatbase] Script already exists, skipping load');
              return true;
            }
            
            const script = document.createElement("script");
            script.src = "https://www.chatbase.co/embed.min.js";
            script.id = "rG3h170PKdOsKKTC078sk";
            script.domain = "www.chatbase.co";
            
            script.onerror = () => {
              console.error('[Chatbase] Script failed to load');
              if (loadAttempts < MAX_LOAD_ATTEMPTS) {
                setTimeout(loadChatbaseScript, 2000);
              }
            };
            
            script.onload = () => {
              console.log('[Chatbase] Script loaded successfully');
              setTimeout(initializeChatbase, 500);
            };
            
            document.body.appendChild(script);
            return true;
          }, 'Script loading');
        };
        
        // Safe initialization
        const initializeChatbase = () => {
          safeChatbaseOperation(() => {
            if (!window.chatbase) {
              console.warn('[Chatbase] Window.chatbase not available after script load');
              return;
            }
            
            const currentUser = getCurrentUserSafely();
            if (currentUser && currentUser.id) {
              window.chatbase("setUserId", currentUser.id);
              console.log('[Chatbase] Initialized with user:', currentUser.id);
            }
            
            // Apply safe styling fixes
            applySafeStyling();
          }, 'Chatbase initialization');
        };
        
        // Minimal, safe styling without complex DOM manipulation
        const applySafeStyling = () => {
          safeChatbaseOperation(() => {
            // Simple CSS injection for z-index fix
            const style = document.createElement('style');
            style.id = 'chatbase-safe-styles';
            style.textContent = `
              /* Safe Chatbase widget positioning */
              *[id*="chatbase"], *[class*="chatbase"], 
              iframe[src*="chatbase.co"], iframe[src*="embed.min.js"] {
                z-index: 2147483647 !important;
                position: fixed !important;
              }
              
              /* Prevent modal overlay interference - minimal approach */
              .fixed.inset-0 {
                pointer-events: none !important;
              }
              
              .fixed.inset-0 > *:not([id*="chatbase"]):not([class*="chatbase"]) {
                pointer-events: auto !important;
              }
            `;
            
            // Only add if not already present
            if (!document.getElementById('chatbase-safe-styles')) {
              document.head.appendChild(style);
            }
          }, 'Safe styling application');
        };
        
        // Main loading function with comprehensive safety
        const loadChatbaseForAuthenticated = () => {
          if (chatbaseLoaded) {
            return;
          }
          
          const currentUser = getCurrentUserSafely();
          if (!currentUser || !currentUser.id) {
            return;
          }
          
          console.log('[Chatbase] Loading for authenticated user:', currentUser.id);
          
          // Initialize chatbase queue safely
          safeChatbaseOperation(() => {
            if (!window.chatbase || window.chatbase("getState") !== "initialized") {
              window.chatbase = (...arguments) => {
                if (!window.chatbase.q) window.chatbase.q = [];
                window.chatbase.q.push(arguments);
              };
            }
          }, 'Queue initialization');
          
          // Load script
          if (loadChatbaseScript()) {
            chatbaseLoaded = true;
          }
        };
        
        // Safe authentication checker with timeout
        let authCheckCount = 0;
        const MAX_AUTH_CHECKS = 30; // Maximum 60 seconds
        
        const checkAuthentication = () => {
          if (authCheckCount >= MAX_AUTH_CHECKS) {
            console.warn('[Chatbase] Authentication check timeout, stopping');
            return;
          }
          
          authCheckCount++;
          const currentUser = getCurrentUserSafely();
          
          if (currentUser && currentUser.id) {
            loadChatbaseForAuthenticated();
          } else {
            setTimeout(checkAuthentication, 2000);
          }
        };
        
        // Start the safe loading process
        if (document.readyState === 'complete') {
          setTimeout(checkAuthentication, 1000);
        } else {
          window.addEventListener('load', () => {
            setTimeout(checkAuthentication, 1000);
          });
        }
        
        console.log('[Chatbase] Crash-safe loader initialized');
      })();
    </script>
    
    <!-- This is a replit script which adds a banner on the top of the page when opened in development mode outside the replit environment -->
    <script type="text/javascript" src="https://replit.com/public/js/replit-dev-banner.js"></script>
  </body>
</html>