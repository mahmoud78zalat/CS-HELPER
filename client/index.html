<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <title>Customer Service Helper</title>
    <style>
      /* Ensure Chatbase widget appears above all modals and overlays */
      .chatbase-widget,
      #chatbase-widget,
      [data-chatbase="widget"],
      [data-widget="chatbase"],
      iframe[src*="chatbase"],
      iframe[src*="embed.min.js"],
      .chatbase-chat-widget,
      div[style*="chatbase"],
      /* Target common Chatbase container patterns */
      div > iframe[src*="chatbase.co"],
      div[id*="chatbase"],
      div[class*="chatbase"],
      /* Ensure all Chatbase-related elements have maximum z-index */
      *[id*="rG3h170PKdOsKKTC078sk"] {
        z-index: 2147483647 !important;
        position: fixed !important;
      }
      
      /* Additional fallback for any chatbase iframe or container */
      body > div:has(iframe[src*="chatbase.co"]),
      body > iframe[src*="chatbase.co"] {
        z-index: 2147483647 !important;
        position: fixed !important;
      }
      
      /* PROVEN FIX: Modal overlay pointer-events solution */
      .fixed.inset-0 {
        pointer-events: none !important;
      }
      
      .fixed.inset-0 > * {
        pointer-events: auto !important;
      }
      
      /* Target all possible modal overlay patterns */
      [data-radix-portal] .fixed.inset-0,
      [role="dialog"] + .fixed.inset-0,
      .modal-overlay,
      .backdrop,
      .overlay {
        pointer-events: none !important;
      }
      
      /* Re-enable for modal content */
      [data-radix-portal] .fixed.inset-0 > *,
      [role="dialog"] + .fixed.inset-0 > *,
      .modal-overlay > *,
      .backdrop > *,
      .overlay > * {
        pointer-events: auto !important;
      }
      
      /* Break stacking context for Chatbase widget */
      div[id*="chatbase"], 
      div[class*="chatbase"] {
        position: static !important;
      }
      
      /* Force Chatbase iframe to top level */
      iframe[src*="chatbase.co"] {
        position: fixed !important;
        z-index: 2147483647 !important;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    
    <!-- Chatbase Integration with User Verification -->
    <script>
      let chatbaseLoaded = false;
      
      const loadChatbaseForAuthenticated = () => {
        const currentUser = window.getCurrentUser && window.getCurrentUser();
        
        if (currentUser && currentUser.id && !chatbaseLoaded) {
          // Load chatbase with user verification
          (function(){
            if(!window.chatbase||window.chatbase("getState")!=="initialized"){
              window.chatbase=(...arguments)=>{
                if(!window.chatbase.q){window.chatbase.q=[]}
                window.chatbase.q.push(arguments)
              };
              window.chatbase=new Proxy(window.chatbase,{
                get(target,prop){
                  if(prop==="q"){return target.q}
                  return(...args)=>target(prop,...args)
                }
              })
            }
            
            const onLoad = async function(){
              // Get verification hash from backend
              try {
                const response = await fetch(`/api/chatbase/verify-hash/${currentUser.id}`);
                const { hash } = await response.json();
                
                const script = document.createElement("script");
                script.src = "https://www.chatbase.co/embed.min.js";
                script.id = "rG3h170PKdOsKKTC078sk";
                script.domain = "www.chatbase.co";
                document.body.appendChild(script);
                
                // Set user identification with hash after script loads
                setTimeout(() => {
                  if (window.chatbase) {
                    window.chatbase("setUserId", currentUser.id, hash);
                    console.log('Chatbase loaded with verified user ID:', currentUser.id);
                    
                    // Ensure widget stays above modals with dynamic detection
                    ensureChatbaseAboveModals();
                  }
                }, 1000);
              } catch (error) {
                console.error('Failed to get chatbase verification hash:', error);
                // Fallback to load without verification
                const script = document.createElement("script");
                script.src = "https://www.chatbase.co/embed.min.js";
                script.id = "rG3h170PKdOsKKTC078sk";
                script.domain = "www.chatbase.co";
                document.body.appendChild(script);
              }
            };
            
            if(document.readyState==="complete"){
              onLoad();
            } else {
              window.addEventListener("load", onLoad);
            }
          })();
          
          chatbaseLoaded = true;
        }
      };
      
      // Check for authentication until user is found
      const authInterval = setInterval(() => {
        const currentUser = window.getCurrentUser && window.getCurrentUser();
        if (currentUser && currentUser.id) {
          loadChatbaseForAuthenticated();
          clearInterval(authInterval);
        }
      }, 2000);
      
      // Initial check
      setTimeout(loadChatbaseForAuthenticated, 1000);
      
      // Enhanced modal detection and widget overlay management
      function ensureChatbaseAboveModals() {
        const chatbaseSelectors = [
          '.chatbase-widget',
          '#chatbase-widget', 
          '[data-chatbase="widget"]',
          '[data-widget="chatbase"]',
          'iframe[src*="chatbase"]',
          'iframe[src*="embed.min.js"]',
          '.chatbase-chat-widget',
          'div[style*="chatbase"]',
          'div > iframe[src*="chatbase.co"]',
          'div[id*="chatbase"]',
          'div[class*="chatbase"]',
          '*[id*="rG3h170PKdOsKKTC078sk"]'
        ];
        
        const ensureWidgetZIndex = () => {
          // PROVEN SOLUTION: Disable pointer events on modal overlays
          const modalOverlays = document.querySelectorAll(
            '.fixed.inset-0, [data-radix-portal] .fixed.inset-0, .modal-overlay, .backdrop, .overlay'
          );
          modalOverlays.forEach(overlay => {
            overlay.style.pointerEvents = 'none';
          });
          
          // Find and fix Chatbase widget positioning
          chatbaseSelectors.forEach(selector => {
            const elements = document.querySelectorAll(selector);
            elements.forEach(element => {
              if (element) {
                // Break out of stacking context
                element.style.position = 'fixed';
                element.style.zIndex = '2147483647';
                element.style.pointerEvents = 'auto';
                
                // If it's an iframe, ensure it's at document level
                if (element.tagName === 'IFRAME') {
                  element.style.position = 'fixed';
                  element.style.zIndex = '2147483647';
                }
                
                // Break parent stacking contexts
                let parent = element.parentElement;
                while (parent && parent !== document.body) {
                  const computed = window.getComputedStyle(parent);
                  // Remove positioning that creates stacking context
                  if (computed.position !== 'static') {
                    parent.style.position = 'static';
                  }
                  parent = parent.parentElement;
                }
              }
            });
          });
          
          // Force all chatbase elements to be clickable
          document.querySelectorAll('*[id*="chatbase"], *[class*="chatbase"], iframe[src*="chatbase"]').forEach(el => {
            el.style.pointerEvents = 'auto';
            el.style.zIndex = '2147483647';
            el.style.position = 'fixed';
          });
        };
        
        // Run immediately and on DOM changes
        ensureWidgetZIndex();
        
        // Watch for new elements being added (including modal overlays)
        const observer = new MutationObserver((mutations) => {
          let shouldCheck = false;
          mutations.forEach(mutation => {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
              shouldCheck = true;
            }
          });
          if (shouldCheck) {
            setTimeout(ensureWidgetZIndex, 100);
          }
        });
        
        observer.observe(document.body, {
          childList: true,
          subtree: true
        });
        
        // Dynamic modal detection and pointer-events fix
        const handleModalOverlays = () => {
          // Apply pointer-events: none to all modal overlays immediately
          const overlays = document.querySelectorAll('.fixed.inset-0, [data-radix-portal] .fixed.inset-0');
          overlays.forEach(overlay => {
            overlay.style.pointerEvents = 'none';
          });
          
          // Ensure modal content remains clickable
          const modalContent = document.querySelectorAll('.fixed.inset-0 > *, [data-radix-portal] .fixed.inset-0 > *');
          modalContent.forEach(content => {
            content.style.pointerEvents = 'auto';
          });
        };
        
        // Apply fixes on every DOM change
        const modalObserver = new MutationObserver(() => {
          handleModalOverlays();
          ensureWidgetZIndex();
        });
        
        modalObserver.observe(document.body, {
          childList: true,
          subtree: true,
          attributes: true,
          attributeFilter: ['class', 'style', 'data-state']
        });
        
        // Force click events through overlays for Chatbase
        document.addEventListener('click', function(e) {
          const clickedElement = e.target;
          const isChatbaseElement = chatbaseSelectors.some(selector => {
            try {
              return clickedElement.matches && clickedElement.matches(selector);
            } catch (err) {
              return false;
            }
          });
          
          if (isChatbaseElement) {
            // Temporarily disable all modal overlays during click
            const overlays = document.querySelectorAll('.fixed.inset-0');
            overlays.forEach(overlay => {
              overlay.style.pointerEvents = 'none';
            });
            
            // Re-enable after click
            setTimeout(() => {
              overlays.forEach(overlay => {
                overlay.style.pointerEvents = 'none'; // Keep disabled for widgets
              });
            }, 10);
          }
        }, true);
        
        // Initial application
        handleModalOverlays();
        
        console.log('Enhanced Chatbase modal overlay protection activated');
      }
    </script>
    
    <!-- This is a replit script which adds a banner on the top of the page when opened in development mode outside the replit environment -->
    <script type="text/javascript" src="https://replit.com/public/js/replit-dev-banner.js"></script>
  </body>
</html>