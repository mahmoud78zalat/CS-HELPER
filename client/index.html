<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <title>Customer Service Helper</title>
    <style>
      /* Ensure Chatbase widget appears above all modals and overlays */
      .chatbase-widget,
      #chatbase-widget,
      [data-chatbase="widget"],
      [data-widget="chatbase"],
      iframe[src*="chatbase"],
      iframe[src*="embed.min.js"],
      .chatbase-chat-widget,
      div[style*="chatbase"],
      /* Target common Chatbase container patterns */
      div > iframe[src*="chatbase.co"],
      div[id*="chatbase"],
      div[class*="chatbase"],
      /* Ensure all Chatbase-related elements have maximum z-index */
      *[id*="rG3h170PKdOsKKTC078sk"] {
        z-index: 2147483647 !important;
        position: fixed !important;
      }
      
      /* Additional fallback for any chatbase iframe or container */
      body > div:has(iframe[src*="chatbase.co"]),
      body > iframe[src*="chatbase.co"] {
        z-index: 2147483647 !important;
        position: fixed !important;
      }
      
      /* CRITICAL FIX: Ensure modal overlays don't block Chatbase widget */
      [data-radix-portal] {
        pointer-events: none !important;
      }
      
      [data-radix-portal] > * {
        pointer-events: auto !important;
      }
      
      /* Ensure modal backdrops don't interfere with widgets */
      [data-state="open"][data-radix-collection-item],
      [data-state="open"] + [data-radix-portal],
      .fixed.inset-0.z-50 {
        pointer-events: none !important;
      }
      
      /* Re-enable pointer events for modal content only */
      [data-state="open"][data-radix-collection-item] > *,
      [data-state="open"] + [data-radix-portal] > *,
      .fixed.inset-0.z-50 > * {
        pointer-events: auto !important;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    
    <!-- Chatbase Integration with User Verification -->
    <script>
      let chatbaseLoaded = false;
      
      const loadChatbaseForAuthenticated = () => {
        const currentUser = window.getCurrentUser && window.getCurrentUser();
        
        if (currentUser && currentUser.id && !chatbaseLoaded) {
          // Load chatbase with user verification
          (function(){
            if(!window.chatbase||window.chatbase("getState")!=="initialized"){
              window.chatbase=(...arguments)=>{
                if(!window.chatbase.q){window.chatbase.q=[]}
                window.chatbase.q.push(arguments)
              };
              window.chatbase=new Proxy(window.chatbase,{
                get(target,prop){
                  if(prop==="q"){return target.q}
                  return(...args)=>target(prop,...args)
                }
              })
            }
            
            const onLoad = async function(){
              // Get verification hash from backend
              try {
                const response = await fetch(`/api/chatbase/verify-hash/${currentUser.id}`);
                const { hash } = await response.json();
                
                const script = document.createElement("script");
                script.src = "https://www.chatbase.co/embed.min.js";
                script.id = "rG3h170PKdOsKKTC078sk";
                script.domain = "www.chatbase.co";
                document.body.appendChild(script);
                
                // Set user identification with hash after script loads
                setTimeout(() => {
                  if (window.chatbase) {
                    window.chatbase("setUserId", currentUser.id, hash);
                    console.log('Chatbase loaded with verified user ID:', currentUser.id);
                    
                    // Ensure widget stays above modals with dynamic detection
                    ensureChatbaseAboveModals();
                  }
                }, 1000);
              } catch (error) {
                console.error('Failed to get chatbase verification hash:', error);
                // Fallback to load without verification
                const script = document.createElement("script");
                script.src = "https://www.chatbase.co/embed.min.js";
                script.id = "rG3h170PKdOsKKTC078sk";
                script.domain = "www.chatbase.co";
                document.body.appendChild(script);
              }
            };
            
            if(document.readyState==="complete"){
              onLoad();
            } else {
              window.addEventListener("load", onLoad);
            }
          })();
          
          chatbaseLoaded = true;
        }
      };
      
      // Check for authentication until user is found
      const authInterval = setInterval(() => {
        const currentUser = window.getCurrentUser && window.getCurrentUser();
        if (currentUser && currentUser.id) {
          loadChatbaseForAuthenticated();
          clearInterval(authInterval);
        }
      }, 2000);
      
      // Initial check
      setTimeout(loadChatbaseForAuthenticated, 1000);
      
      // Enhanced modal detection and widget overlay management
      function ensureChatbaseAboveModals() {
        const chatbaseSelectors = [
          '.chatbase-widget',
          '#chatbase-widget', 
          '[data-chatbase="widget"]',
          '[data-widget="chatbase"]',
          'iframe[src*="chatbase"]',
          'iframe[src*="embed.min.js"]',
          '.chatbase-chat-widget',
          'div[style*="chatbase"]',
          'div > iframe[src*="chatbase.co"]',
          'div[id*="chatbase"]',
          'div[class*="chatbase"]',
          '*[id*="rG3h170PKdOsKKTC078sk"]'
        ];
        
        const ensureWidgetZIndex = () => {
          chatbaseSelectors.forEach(selector => {
            const elements = document.querySelectorAll(selector);
            elements.forEach(element => {
              if (element) {
                element.style.zIndex = '2147483647';
                element.style.position = 'fixed';
                element.style.pointerEvents = 'auto';
                
                // Also check parent containers
                let parent = element.parentElement;
                while (parent && parent !== document.body) {
                  if (parent.style.zIndex && parseInt(parent.style.zIndex) < 2147483647) {
                    parent.style.zIndex = '2147483647';
                  }
                  parent.style.pointerEvents = 'auto';
                  parent = parent.parentElement;
                }
              }
            });
          });
          
          // Additional aggressive fix for modal overlays
          const modalOverlays = document.querySelectorAll(
            '[data-radix-portal], [data-state="open"], .fixed.inset-0, .backdrop, .overlay'
          );
          modalOverlays.forEach(overlay => {
            if (overlay && overlay.style.zIndex && parseInt(overlay.style.zIndex) >= 2147483647) {
              overlay.style.pointerEvents = 'none';
            }
          });
          
          // Force enable pointer events on all chatbase-related elements
          document.querySelectorAll('*[id*="chatbase"], *[class*="chatbase"], iframe[src*="chatbase"]').forEach(el => {
            el.style.pointerEvents = 'auto';
            el.style.zIndex = '2147483647';
          });
        };
        
        // Run immediately and on DOM changes
        ensureWidgetZIndex();
        
        // Watch for new elements being added (including modal overlays)
        const observer = new MutationObserver((mutations) => {
          let shouldCheck = false;
          mutations.forEach(mutation => {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
              shouldCheck = true;
            }
          });
          if (shouldCheck) {
            setTimeout(ensureWidgetZIndex, 100);
          }
        });
        
        observer.observe(document.body, {
          childList: true,
          subtree: true
        });
        
        // Ultimate fix: Force click events through modal overlays
        document.addEventListener('click', function(e) {
          // Check if click was blocked by an overlay
          const clickedElement = e.target;
          const isChatbaseElement = chatbaseSelectors.some(selector => {
            try {
              return clickedElement.matches && clickedElement.matches(selector);
            } catch (err) {
              return false;
            }
          });
          
          if (isChatbaseElement) {
            // Ensure this click goes through
            e.stopPropagation();
            e.stopImmediatePropagation();
          }
        }, true);
        
        console.log('Enhanced Chatbase modal overlay protection activated');
      }
    </script>
    
    <!-- This is a replit script which adds a banner on the top of the page when opened in development mode outside the replit environment -->
    <script type="text/javascript" src="https://replit.com/public/js/replit-dev-banner.js"></script>
  </body>
</html>