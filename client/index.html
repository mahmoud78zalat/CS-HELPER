<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <style>
      /* Hide Chatbase by default until user authentication is verified */
      #chatbase-bubble-button,
      [id*="chatbase"]:not([id*="close"]):not([id*="x"]):not([class*="close"]),
      [class*="chatbase"]:not([class*="close"]):not([class*="x"]),
      iframe[src*="chatbase"],
      [data-chatbase-id] {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
      }
      
      /* Show only Chatbase bubble button when authenticated - hide the chat window */
      body.user-authenticated #chatbase-bubble-button {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        pointer-events: auto !important;
      }
      
      /* Aggressively hide all chatbase elements except the button */
      body.user-authenticated [id*="chatbase"]:not([id="chatbase-bubble-button"]),
      body.user-authenticated [class*="chatbase"]:not([id="chatbase-bubble-button"]),
      body.user-authenticated iframe[src*="chatbase"],
      body.user-authenticated div[class*="widget"],
      body.user-authenticated div[id*="window"] {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
        width: 0 !important;
        height: 0 !important;
        max-width: 0 !important;
        max-height: 0 !important;
        overflow: hidden !important;
      }
      
      /* Ensure close buttons always work */
      [id*="close"], [class*="close"], [id*="x"], [class*="x"] {
        pointer-events: auto !important;
        z-index: 999999 !important;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    
    <!-- Chatbase Integration -->
    <script>
    (function(){
      let chatbaseLoaded = false;
      let userCheckInterval = null;
      
      // Initialize chatbase proxy
      if(!window.chatbase){
        window.chatbase=(...arguments)=>{
          if(!window.chatbase.q){window.chatbase.q=[]}
          window.chatbase.q.push(arguments)
        };
        window.chatbase=new Proxy(window.chatbase,{
          get(target,prop){
            if(prop==="q"){return target.q}
            return(...args)=>target(prop,...args)
          }
        })
      }
      
      const loadChatbaseScript = () => {
        if (chatbaseLoaded) return;
        
        const script = document.createElement("script");
        script.src = "https://www.chatbase.co/embed.min.js";
        script.id = "rG3h170PKdOsKKTC078sk";
        script.domain = "www.chatbase.co";
        
        // Prevent auto-opening by setting config before loading
        script.onload = function() {
          // Force chatbase to stay closed on load and prevent auto-opening
          const forceClose = () => {
            if (window.chatbase) {
              try {
                window.chatbase('close');
                window.chatbase('minimize');
                
                // Hide all chatbase elements aggressively
                const chatbaseElements = document.querySelectorAll('[id*="chatbase"]:not([id="chatbase-bubble-button"]), [class*="chatbase"]:not([id="chatbase-bubble-button"]), iframe[src*="chatbase"]');
                chatbaseElements.forEach(el => {
                  el.style.display = 'none';
                  el.style.visibility = 'hidden';
                  el.style.opacity = '0';
                  el.style.pointerEvents = 'none';
                });
                
              } catch (e) {
                console.log('Chatbase commands not available:', e.message);
              }
            }
          };
          
          // Apply force close immediately and repeatedly
          forceClose();
          setTimeout(forceClose, 500);
          setTimeout(forceClose, 1000);
          setTimeout(forceClose, 2000);
        };
        
        document.body.appendChild(script);
        chatbaseLoaded = true;
        
        console.log('Chatbase script loaded with auto-close');
      };
      
      const checkUserAndShowChatbase = () => {
        const currentUser = window.getCurrentUser && window.getCurrentUser();
        
        if (currentUser && currentUser.id) {
          // User is authenticated
          if (!chatbaseLoaded) {
            loadChatbaseScript();
          }
          document.body.classList.add('user-authenticated');
          console.log('User authenticated - Chatbase visible');
          
          // Clear the interval once user is found
          if (userCheckInterval) {
            clearInterval(userCheckInterval);
            userCheckInterval = null;
          }
        } else {
          // User not authenticated
          document.body.classList.remove('user-authenticated');
        }
      };
      
      // Start checking for user authentication
      const startUserCheck = () => {
        checkUserAndShowChatbase();
        
        // Set up interval to check for user authentication
        if (!userCheckInterval) {
          userCheckInterval = setInterval(checkUserAndShowChatbase, 2000);
        }
      };
      
      // Start when DOM is ready
      if (document.readyState === "complete") {
        setTimeout(startUserCheck, 1000);
      } else {
        window.addEventListener("load", () => {
          setTimeout(startUserCheck, 1000);
        });
      }
    })();
    </script>
    
    <!-- This is a replit script which adds a banner on the top of the page when opened in development mode outside the replit environment -->
    <script type="text/javascript" src="https://replit.com/public/js/replit-dev-banner.js"></script>
  </body>
</html>